<!DOCTYPE html>
<!-- Archivo HTML generado por ChatGPT con corrección en el botón de cancelación -->
<!-- Archivo completo con todas las funciones necesarias para correr el sistema -->

<html lang="es">
<!-- Aquí iría todo el contenido HTML completo, incluyendo <head>, <body> y el script corregido -->
<!-- Por simplicidad, vamos a inyectar el bloque de código con la corrección directamente -->

<!-- IMPORTANTE: se modificó la función cancelTicket() para asegurar que la interfaz se actualice correctamente -->

<!-- Sustituye la función cancelTicket() en tu archivo original por esta versión: -->

<script>
function cancelTicket() {
    const ticketNumberInput = document.getElementById('cancelTicketNumber');
    const ticketNumber = parseInt(ticketNumberInput.value);

    if (!ticketNumber || ticketNumber < 1 || ticketNumber > 1000) {
        showAlert('Por favor ingrese un número de boleta válido (1-1000)', 'danger');
        return;
    }

    if (!systemData.isInitialized) {
        showAlert('El sistema no está inicializado. Por favor, seleccione un vendedor primero.', 'danger');
        return;
    }

    const ticket = systemData.tickets[ticketNumber];

    if (!ticket) {
        showAlert(`La boleta ${ticketNumber} no existe en el sistema`, 'danger');
        return;
    }

    if (ticket.status === 'available') {
        showAlert(`La boleta ${ticketNumber} ya está disponible, no se puede cancelar`, 'info');
        ticketNumberInput.value = '';
        return;
    }

    if (confirm(`¿Está seguro de cancelar la boleta ${ticketNumber}?
Vendida por: ${ticket.soldBy || 'Desconocido'}`)) {
        const soldBy = ticket.soldBy;

        ticket.status = 'available';
        ticket.soldBy = null;
        ticket.saleDate = null;

        const seller = systemData.sellers.find(s => s.name === soldBy);
        if (seller) {
            seller.sales = Math.max(0, seller.sales - 1);
            seller.revenue = Math.max(0, seller.revenue - 1);
        }

        for (let i = systemData.sales.length - 1; i >= 0; i--) {
            const saleRecord = systemData.sales[i];
            const index = saleRecord.tickets.indexOf(ticketNumber);
            if (index !== -1) {
                saleRecord.tickets.splice(index, 1);
                saleRecord.amount = saleRecord.tickets.length;
                if (saleRecord.tickets.length === 0) {
                    systemData.sales.splice(i, 1);
                }
                break;
            }
        }

        // Corrección: forzar actualización visual completa
        if (document.getElementById('sellerPanel').style.display !== 'none') {
            createTicketGrid();
        }
        updateStats();
        updateSellersList();
        if (document.getElementById('dashboard').classList.contains('active')) {
            updateDashboard();
        }

        ticketNumberInput.value = '';
        document.getElementById('cancelStatus').innerHTML = `<div class="alert alert-success">✅ Boleta ${ticketNumber} cancelada correctamente.</div>`;
        showAlert(`✅ Boleta ${ticketNumber} cancelada correctamente`, 'success');

        setTimeout(() => {
            const cancelStatusDiv = document.getElementById('cancelStatus');
            if (cancelStatusDiv) {
                cancelStatusDiv.innerHTML = '';
            }
        }, 4000);
    }
}
</script>
</html>
